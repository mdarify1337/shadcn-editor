{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "inline-image-plugin",
  "type": "registry:ui",
  "author": "shadcn (https://ui.shadcn.com)",
  "files": [
    {
      "path": "editor/plugins/inline-image-plugin.tsx",
      "content": "'use client'\r\n\r\n/**\r\n * Copyright (c) Meta Platforms, Inc. and affiliates.\r\n *\r\n * This source code is licensed under the MIT license found in the\r\n * LICENSE file in the root directory of this source tree.\r\n *\r\n */\r\nimport * as React from 'react'\r\nimport { useEffect, useRef, useState, JSX } from 'react'\r\n\r\n// import '../nodes/inline-image-node.css';\r\nimport { useLexicalComposerContext } from '@lexical/react/LexicalComposerContext'\r\nimport { $wrapNodeInElement, mergeRegister } from '@lexical/utils'\r\nimport {\r\n  $createParagraphNode,\r\n  $createRangeSelection,\r\n  $getSelection,\r\n  $insertNodes,\r\n  $isNodeSelection,\r\n  $isRootOrShadowRoot,\r\n  $setSelection,\r\n  COMMAND_PRIORITY_EDITOR,\r\n  COMMAND_PRIORITY_HIGH,\r\n  COMMAND_PRIORITY_LOW,\r\n  DRAGOVER_COMMAND,\r\n  DRAGSTART_COMMAND,\r\n  DROP_COMMAND,\r\n  LexicalCommand,\r\n  LexicalEditor,\r\n  createCommand,\r\n} from 'lexical'\r\n\r\nimport { Button } from '@/registry/default/ui/button'\r\nimport { Checkbox } from '@/registry/default/ui/checkbox'\r\nimport { Input } from '@/registry/default/ui/input'\r\nimport { Label } from '@/registry/default/ui/label'\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/registry/default/ui/select'\r\n\r\nimport type { Position } from '@/registry/default/editor/nodes/inline-image-node'\r\nimport {\r\n  $createInlineImageNode,\r\n  $isInlineImageNode,\r\n  InlineImageNode,\r\n  InlineImagePayload,\r\n} from '@/registry/default/editor/nodes/inline-image-node'\r\nimport { CAN_USE_DOM } from '@/registry/default/editor/shared/can-use-dom'\r\n\r\nexport type InsertInlineImagePayload = Readonly<InlineImagePayload>\r\n\r\nconst getDOMSelection = (targetWindow: Window | null): Selection | null =>\r\n  CAN_USE_DOM ? (targetWindow || window).getSelection() : null\r\n\r\nexport const INSERT_INLINE_IMAGE_COMMAND: LexicalCommand<InlineImagePayload> =\r\n  createCommand('INSERT_INLINE_IMAGE_COMMAND')\r\n\r\nexport function InsertInlineImageDialog({\r\n  activeEditor,\r\n  onClose,\r\n}: {\r\n  activeEditor: LexicalEditor\r\n  onClose: () => void\r\n}): JSX.Element {\r\n  const hasModifier = useRef(false)\r\n\r\n  const [src, setSrc] = useState('')\r\n  const [altText, setAltText] = useState('')\r\n  const [showCaption, setShowCaption] = useState(false)\r\n  const [position, setPosition] = useState<Position>('left')\r\n\r\n  const isDisabled = src === ''\r\n\r\n  const handleShowCaptionChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    setShowCaption(e.target.checked)\r\n  }\r\n\r\n  const handlePositionChange = (e: React.ChangeEvent<HTMLSelectElement>) => {\r\n    setPosition(e.target.value as Position)\r\n  }\r\n\r\n  const loadImage = (files: FileList | null) => {\r\n    const reader = new FileReader()\r\n    reader.onload = function () {\r\n      if (typeof reader.result === 'string') {\r\n        setSrc(reader.result)\r\n      }\r\n      return ''\r\n    }\r\n    if (files !== null) {\r\n      reader.readAsDataURL(files[0])\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    hasModifier.current = false\r\n    const handler = (e: KeyboardEvent) => {\r\n      hasModifier.current = e.altKey\r\n    }\r\n    document.addEventListener('keydown', handler)\r\n    return () => {\r\n      document.removeEventListener('keydown', handler)\r\n    }\r\n  }, [activeEditor])\r\n\r\n  const handleOnClick = () => {\r\n    const payload = { altText, position, showCaption, src }\r\n    activeEditor.dispatchCommand(INSERT_INLINE_IMAGE_COMMAND, payload)\r\n    onClose()\r\n  }\r\n\r\n  return (\r\n    <div className=\"grid gap-4 py-4\">\r\n      <div className=\"grid gap-2\">\r\n        <Label htmlFor=\"image\">Image Upload</Label>\r\n        <Input\r\n          id=\"image\"\r\n          type=\"file\"\r\n          onChange={(e) => loadImage(e.target.files)}\r\n          accept=\"image/*\"\r\n          data-test-id=\"image-modal-file-upload\"\r\n        />\r\n      </div>\r\n      <div className=\"grid gap-2\">\r\n        <Label htmlFor=\"alt-text\">Alt Text</Label>\r\n        <Input\r\n          id=\"alt-text\"\r\n          placeholder=\"Descriptive alternative text\"\r\n          onChange={(e) => setAltText(e.target.value)}\r\n          value={altText}\r\n          data-test-id=\"image-modal-alt-text-input\"\r\n        />\r\n      </div>\r\n      <div className=\"grid gap-2\">\r\n        <Label htmlFor=\"position\">Position</Label>\r\n        <Select\r\n          defaultValue=\"left\"\r\n          onValueChange={(value) => setPosition(value as Position)}\r\n        >\r\n          <SelectTrigger id=\"position\">\r\n            <SelectValue placeholder=\"Select position\" />\r\n          </SelectTrigger>\r\n          <SelectContent>\r\n            <SelectItem value=\"left\">Left</SelectItem>\r\n            <SelectItem value=\"right\">Right</SelectItem>\r\n            <SelectItem value=\"full\">Full Width</SelectItem>\r\n          </SelectContent>\r\n        </Select>\r\n      </div>\r\n      <div className=\"flex items-center space-x-2\">\r\n        <Checkbox\r\n          id=\"caption\"\r\n          checked={showCaption}\r\n          onCheckedChange={(checked) => setShowCaption(checked as boolean)}\r\n        />\r\n        <Label htmlFor=\"caption\">Show Caption</Label>\r\n      </div>\r\n      <Button\r\n        data-test-id=\"image-modal-file-upload-btn\"\r\n        disabled={isDisabled}\r\n        onClick={() => handleOnClick()}\r\n      >\r\n        Confirm\r\n      </Button>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport function InlineImagePlugin(): JSX.Element | null {\r\n  const [editor] = useLexicalComposerContext()\r\n\r\n  useEffect(() => {\r\n    if (!editor.hasNodes([InlineImageNode])) {\r\n      throw new Error('ImagesPlugin: ImageNode not registered on editor')\r\n    }\r\n\r\n    return mergeRegister(\r\n      editor.registerCommand<InsertInlineImagePayload>(\r\n        INSERT_INLINE_IMAGE_COMMAND,\r\n        (payload) => {\r\n          const imageNode = $createInlineImageNode(payload)\r\n          $insertNodes([imageNode])\r\n          if ($isRootOrShadowRoot(imageNode.getParentOrThrow())) {\r\n            $wrapNodeInElement(imageNode, $createParagraphNode).selectEnd()\r\n          }\r\n\r\n          return true\r\n        },\r\n        COMMAND_PRIORITY_EDITOR\r\n      ),\r\n      editor.registerCommand<DragEvent>(\r\n        DRAGSTART_COMMAND,\r\n        (event) => {\r\n          return $onDragStart(event)\r\n        },\r\n        COMMAND_PRIORITY_HIGH\r\n      ),\r\n      editor.registerCommand<DragEvent>(\r\n        DRAGOVER_COMMAND,\r\n        (event) => {\r\n          return $onDragover(event)\r\n        },\r\n        COMMAND_PRIORITY_LOW\r\n      ),\r\n      editor.registerCommand<DragEvent>(\r\n        DROP_COMMAND,\r\n        (event) => {\r\n          return $onDrop(event, editor)\r\n        },\r\n        COMMAND_PRIORITY_HIGH\r\n      )\r\n    )\r\n  }, [editor])\r\n\r\n  return null\r\n}\r\n\r\nfunction $onDragStart(event: DragEvent): boolean {\r\n  const node = $getImageNodeInSelection()\r\n  if (!node) {\r\n    return false\r\n  }\r\n  const dataTransfer = event.dataTransfer\r\n  if (!dataTransfer) {\r\n    return false\r\n  }\r\n  const TRANSPARENT_IMAGE =\r\n    'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'\r\n  const img = document.createElement('img')\r\n  img.src = TRANSPARENT_IMAGE\r\n  dataTransfer.setData('text/plain', '_')\r\n  dataTransfer.setDragImage(img, 0, 0)\r\n  dataTransfer.setData(\r\n    'application/x-lexical-drag',\r\n    JSON.stringify({\r\n      data: {\r\n        altText: node.__altText,\r\n        caption: node.__caption,\r\n        height: node.__height,\r\n        key: node.getKey(),\r\n        showCaption: node.__showCaption,\r\n        src: node.__src,\r\n        width: node.__width,\r\n      },\r\n      type: 'image',\r\n    })\r\n  )\r\n\r\n  return true\r\n}\r\n\r\nfunction $onDragover(event: DragEvent): boolean {\r\n  const node = $getImageNodeInSelection()\r\n  if (!node) {\r\n    return false\r\n  }\r\n  if (!canDropImage(event)) {\r\n    event.preventDefault()\r\n  }\r\n  return true\r\n}\r\n\r\nfunction $onDrop(event: DragEvent, editor: LexicalEditor): boolean {\r\n  const node = $getImageNodeInSelection()\r\n  if (!node) {\r\n    return false\r\n  }\r\n  const data = getDragImageData(event)\r\n  if (!data) {\r\n    return false\r\n  }\r\n  event.preventDefault()\r\n  if (canDropImage(event)) {\r\n    const range = getDragSelection(event)\r\n    node.remove()\r\n    const rangeSelection = $createRangeSelection()\r\n    if (range !== null && range !== undefined) {\r\n      rangeSelection.applyDOMRange(range)\r\n    }\r\n    $setSelection(rangeSelection)\r\n    editor.dispatchCommand(INSERT_INLINE_IMAGE_COMMAND, data)\r\n  }\r\n  return true\r\n}\r\n\r\nfunction $getImageNodeInSelection(): InlineImageNode | null {\r\n  const selection = $getSelection()\r\n  if (!$isNodeSelection(selection)) {\r\n    return null\r\n  }\r\n  const nodes = selection.getNodes()\r\n  const node = nodes[0]\r\n  return $isInlineImageNode(node) ? node : null\r\n}\r\n\r\nfunction getDragImageData(event: DragEvent): null | InsertInlineImagePayload {\r\n  const dragData = event.dataTransfer?.getData('application/x-lexical-drag')\r\n  if (!dragData) {\r\n    return null\r\n  }\r\n  const { type, data } = JSON.parse(dragData)\r\n  if (type !== 'image') {\r\n    return null\r\n  }\r\n\r\n  return data\r\n}\r\n\r\ndeclare global {\r\n  interface DragEvent {\r\n    rangeOffset?: number\r\n    rangeParent?: Node\r\n  }\r\n}\r\n\r\nfunction canDropImage(event: DragEvent): boolean {\r\n  const target = event.target\r\n  return !!(\r\n    target &&\r\n    target instanceof HTMLElement &&\r\n    !target.closest('code, span.editor-image') &&\r\n    target.parentElement &&\r\n    target.parentElement.closest('div.ContentEditable__root')\r\n  )\r\n}\r\n\r\nfunction getDragSelection(event: DragEvent): Range | null | undefined {\r\n  let range\r\n  const target = event.target as null | Element | Document\r\n  const targetWindow =\r\n    target == null\r\n      ? null\r\n      : target.nodeType === 9\r\n        ? (target as Document).defaultView\r\n        : (target as Element).ownerDocument.defaultView\r\n  const domSelection = getDOMSelection(targetWindow)\r\n  if (document.caretRangeFromPoint) {\r\n    range = document.caretRangeFromPoint(event.clientX, event.clientY)\r\n  } else if (event.rangeParent && domSelection !== null) {\r\n    domSelection.collapse(event.rangeParent, event.rangeOffset || 0)\r\n    range = domSelection.getRangeAt(0)\r\n  } else {\r\n    throw Error('Cannot get the selection when dragging')\r\n  }\r\n\r\n  return range\r\n}\r\n",
      "type": "registry:component",
      "target": "components/editor/plugins/inline-image-plugin.tsx"
    }
  ]
}